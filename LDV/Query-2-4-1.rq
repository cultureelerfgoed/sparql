#+ name: Query-2-4-1
#+ endpoint: https://api.linkeddata.cultureelerfgoed.nl/datasets/rce/Rijksmonumenten-sdo/sparql

PREFIX schema:<https://schema.org/>

SELECT
  ?primaireCategorie
  ?aantal
  (SUM(?aantal2) AS ?cumulatief)
WHERE {

  ############################################
  # 1. Telling per primaire categorie
  ############################################
  {
    SELECT
      ?primaireCategorie
      ?ord
      (COUNT(DISTINCT ?choi) AS ?aantal)
    WHERE {
      ?choi schema:description ?omschrijving .
      BIND(LCASE(STR(?omschrijving)) AS ?omslLc)

      VALUES ?zoekterm {
        "niet beschermd" "niet-beschermd" "niet van waarde" "geen monumentale waarde"
        "ondergeschikte waarde" "geen onderdeel" "uitgesloten" "uitgezonderd"
        "niet opgenomen" "niet onder bescherming" "ondergeschikt"
        "van ondergeschikt belang" "secundair" "onderdeel van" "in samenhang met"
        "niet meebeschermd" "niet-meebeschermd" "niet in aanmerking"
        "buiten bescherming" "niet nader te beschermen" "niet oorspronkelijk"
        "niet originele" "niet origineel" "in recente tijd" "ondergeschikte betekenis"
        "sterk gewijzigd" "ingrijpend gewijzigd" "aanzienlijk gewijzigd"
      }

      FILTER(CONTAINS(?omslLc, LCASE(?zoekterm)))

      BIND(
        "niet-?\\s*beschermd|niet\\s+van\\s+waarde|geen\\s+onderdeel|uitgezonderd|niet\\s+opgenomen|niet\\s+onder\\s+bescherming|\\buitgesloten\\b|niet-?\\s*meebeschermd|niet\\s+in\\s+aanmerking|\\bafgebroken\\b|buiten\\s+bescherming|niet\\s+nader\\s+te\\s+beschermen"
        AS ?patUitsl
      )

      BIND(
        "\\bondergeschikt(e)?\\b|\\bmodern(e)?\\b|van\\s+ondergeschikt\\s+belang|ondergeschikte\\s+betekenis|\\bsecundair(e)?\\b|van\\s+weinig\\s+waarde|weinig\\s+waarde|\\bgering(e|ere)?\\b|van\\s+geringe\\s+waarde|\\bstorend\\b|geen\\s+monumentale\\s+waarde|niet\\s+oorspronkelijk(e)?|niet\\s+origineel(e)?|in\\s+recente\\s+tijd|\\b(sterk|ingrijpend|aanzienlijk)\\s+gewijzigd\\b"
        AS ?patRel
      )

      BIND(
        "\\bals\\s+onderdeel\\s+van\\b|\\bonderdeel\\s+van\\s+(een\\s+)?(complex|ensemble|begraafplaats|stadsgezicht)|in\\s+samenhang\\s+met\\s+de\\s+bescherming|aanmerking\\s+voor|\\baanmerking\\b"
        AS ?patReden
      )

      BIND(REGEX(?omslLc, ?patUitsl) AS ?heeftUitsluiting)
      BIND(REGEX(?omslLc, ?patRel)   AS ?heeftRelatieveWaardering)
      BIND(REGEX(?omslLc, ?patReden) AS ?heeftReden)

      FILTER(?heeftUitsluiting || ?heeftRelatieveWaardering || ?heeftReden)

      BIND(
        IF(?heeftUitsluiting, "uitsluiting of beperking",
          IF(?heeftRelatieveWaardering, "relatieve waardering",
            "verwijzing naar reden van bescherming"
          )
        ) AS ?primaireCategorie
      )

      # Vaste volgorde voor cumulatieve lijn
      VALUES (?primaireCategorie ?ord) {
        ("verwijzing naar reden van bescherming" 1)
        ("relatieve waardering"                   2)
        ("uitsluiting of beperking"               3)
      }
    }
    GROUP BY ?primaireCategorie ?ord
  }

  ############################################
  # 2. Zelfde telling nog een keer, voor cumulatie
  ############################################
  {
    SELECT
      ?ord2
      (COUNT(DISTINCT ?choi2) AS ?aantal2)
    WHERE {
      ?choi2 schema:description ?omschrijving2 .
      BIND(LCASE(STR(?omschrijving2)) AS ?omslLc2)

      VALUES ?zoekterm2 {
        "niet beschermd" "niet-beschermd" "niet van waarde" "geen monumentale waarde"
        "ondergeschikte waarde" "geen onderdeel" "uitgesloten" "uitgezonderd"
        "niet opgenomen" "niet onder bescherming" "ondergeschikt"
        "van ondergeschikt belang" "secundair" "onderdeel van" "in samenhang met"
        "niet meebeschermd" "niet-meebeschermd" "niet in aanmerking"
        "buiten bescherming" "niet nader te beschermen" "niet oorspronkelijk"
        "niet originele" "niet origineel" "in recente tijd" "ondergeschikte betekenis"
        "sterk gewijzigd" "ingrijpend gewijzigd" "aanzienlijk gewijzigd"
      }

      FILTER(CONTAINS(?omslLc2, LCASE(?zoekterm2)))

      BIND(
        "niet-?\\s*beschermd|niet\\s+van\\s+waarde|geen\\s+onderdeel|uitgezonderd|niet\\s+opgenomen|niet\\s+onder\\s+bescherming|\\buitgesloten\\b|niet-?\\s*meebeschermd|niet\\s+in\\s+aanmerking|\\bafgebroken\\b|buiten\\s+bescherming|niet\\s+nader\\s+te\\s+beschermen"
        AS ?patUitsl2
      )

      BIND(
        "\\bondergeschikt(e)?\\b|\\bmodern(e)?\\b|van\\s+ondergeschikt\\s+belang|ondergeschikte\\s+betekenis|\\bsecundair(e)?\\b|van\\s+weinig\\s+waarde|weinig\\s+waarde|\\bgering(e|ere)?\\b|van\\s+geringe\\s+waarde|\\bstorend\\b|geen\\s+monumentale\\s+waarde|niet\\s+oorspronkelijk(e)?|niet\\s+origineel(e)?|in\\s+recente\\s+tijd|\\b(sterk|ingrijpend|aanzienlijk)\\s+gewijzigd\\b"
        AS ?patRel2
      )

      BIND(
        "\\bals\\s+onderdeel\\s+van\\b|\\bonderdeel\\s+van\\s+(een\\s+)?(complex|ensemble|begraafplaats|stadsgezicht)|in\\s+samenhang\\s+met\\s+de\\s+bescherming|aanmerking\\s+voor|\\baanmerking\\b"
        AS ?patReden2
      )

      BIND(REGEX(?omslLc2, ?patUitsl2) AS ?hU2)
      BIND(REGEX(?omslLc2, ?patRel2)   AS ?hR2)
      BIND(REGEX(?omslLc2, ?patReden2) AS ?hV2)

      FILTER(?hU2 || ?hR2 || ?hV2)

      BIND(
        IF(?hU2, "uitsluiting of beperking",
          IF(?hR2, "relatieve waardering",
            "verwijzing naar reden van bescherming"
          )
        ) AS ?primaireCategorie2
      )

      VALUES (?primaireCategorie2 ?ord2) {
        ("verwijzing naar reden van bescherming" 1)
        ("relatieve waardering"                   2)
        ("uitsluiting of beperking"               3)
      }
    }
    GROUP BY ?ord2
  }

  # 3. Cumulatieve som over ord
  FILTER(?ord2 <= ?ord)
}
GROUP BY ?primaireCategorie ?aantal ?ord
ORDER BY ?ord
