#+ name: Query-4-10
#+ endpoint: https://api.linkeddata.cultureelerfgoed.nl/datasets/rce/Rijksmonumenten-sdo/sparql

PREFIX schema:<https://schema.org/>
PREFIX rdf:   <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX ceo:   <https://linkeddata.cultureelerfgoed.nl/def/ceo#>
PREFIX edm:   <http://www.europeana.eu/schemas/edm/>
PREFIX dc:    <http://purl.org/dc/elements/1.1/>

SELECT DISTINCT
  (IRI(CONCAT("https://monumentenregister.cultureelerfgoed.nl/monumenten/", ?rijksmonumentnummer)) AS ?monumentenregister)
  (GROUP_CONCAT(DISTINCT ?functies; SEPARATOR=" | ") AS ?functies_)
  ?literal
  ?monumentaard
  ?heeftUitsluiting
  ?heeftRelatieveWaardering
  ?heeftReden
  ?primaireCategorie
  ?categorieen
WHERE {

  ########################################################
  # 0) Basisgegevens
  ########################################################

  ?choi schema:description ?omschrijving ;
        schema:identifier  ?rijksmonumentnummer ;
        schema:category    ?monumentaard .

  OPTIONAL {
    ?choi schema:additionalType ?functie .
    BIND(REPLACE(?functie, "\\s\\(.*\\)|\\(.*\\)", "") AS ?functies)
  }

  # voor compatibiliteit met de oude query: literal = omschrijving
  BIND(?omschrijving AS ?literal)

  # Omschrijving in lowercase
  BIND(LCASE(STR(?omschrijving)) AS ?omslLc)

  ########################################################
  # 1) zoektermen als VALUES (snelle voorfilter)
  ########################################################

  VALUES ?zoekterm {
    "niet beschermd" "niet-beschermd" "niet van waarde"
    "geen monumentale waarde" "ondergeschikte waarde"
    "geen onderdeel" "uitgesloten" "uitgezonderd"
    "niet opgenomen" "niet onder bescherming"
    "ondergeschikt" "van ondergeschikt belang" "secundair"
    "onderdeel van" "in samenhang met"
    "niet meebeschermd" "niet-meebeschermd"
    "niet in aanmerking" "buiten bescherming"
    "niet nader te beschermen"
    "niet oorspronkelijk" "niet originele" "niet origineel"
    "in recente tijd"
    "ondergeschikte betekenis"
    "sterk gewijzigd" "ingrijpend gewijzigd" "aanzienlijk gewijzigd"
  }

  # eerst eenvoudige substring-filter (sneller dan regex op alles)
  FILTER(CONTAINS(?omslLc, LCASE(?zoekterm)))

  ########################################################
  # 2) classificatie via regex (Virtuoso-proof)
  ########################################################

  BIND(
    "niet-?\\s*beschermd|niet\\s+van\\s+waarde|geen\\s+onderdeel|uitgezonderd|niet\\s+opgenomen|niet\\s+onder\\s+bescherming|\\buitgesloten\\b|niet-?\\s*meebeschermd|niet\\s+in\\s+aanmerking|\\bafgebroken\\b|buiten\\s+bescherming|niet\\s+nader\\s+te\\s+beschermen"
    AS ?patUitsl
  )

  BIND(
    "\\bondergeschikt(e)?\\b|\\bmodern(e)?\\b|van\\s+ondergeschikt\\s+belang|ondergeschikte\\s+betekenis|\\bsecundair(e)?\\b|van\\s+weinig\\s+waarde|weinig\\s+waarde|\\bgering(e|ere)?\\b|van\\s+geringe\\s+waarde|\\bstorend\\b|geen\\s+monumentale\\s+waarde|niet\\s+oorspronkelijk(e)?|niet\\s+origineel(e)?|in\\s+recente\\s+tijd|\\b(sterk|ingrijpend|aanzienlijk)\\s+gewijzigd\\b"
    AS ?patRel
  )

  BIND(
    "in\\s+samenhang\\s+met\\s+de\\s+bescherming|aanmerking\\s+voor|\\baanmerking\\b"
    AS ?patReden
  )

  BIND(REGEX(?omslLc, ?patUitsl) AS ?heeftUitsluiting)
  BIND(REGEX(?omslLc, ?patRel)   AS ?heeftRelatieveWaardering)
  BIND(REGEX(?omslLc, ?patReden) AS ?heeftReden)

  # minstens één van de drie booleans moet waar zijn
  FILTER(?heeftUitsluiting || ?heeftRelatieveWaardering || ?heeftReden)

  # primaire categorie (vaste prioriteit)
  BIND(
    IF(?heeftUitsluiting, "uitsluiting of beperking",
      IF(?heeftRelatieveWaardering, "relatieve waardering",
        "verwijzing naar reden van bescherming"
      )
    ) AS ?primaireCategorie
  )

  # uitsluiten van een bekende ruisformulering
  FILTER(!REGEX(?omslLc, "van\\s+belang\\s+als\\s+onderdeel\\s+van"))

  # alle geldige categorieën in één veld
  BIND(CONCAT(
    IF(?heeftUitsluiting,         "uitsluiting of beperking|",              ""),
    IF(?heeftRelatieveWaardering, "relatieve waardering|",                  ""),
    IF(?heeftReden,               "verwijzing naar reden van bescherming|", "")
  ) AS ?_cats)

  BIND(REPLACE(?_cats, "\\|$", "") AS ?categorieen)
}
GROUP BY
  ?monumentenregister
  ?rijksmonumentnummer
  ?literal
  ?monumentaard
  ?heeftUitsluiting
  ?heeftRelatieveWaardering
  ?heeftReden
  ?primaireCategorie
  ?categorieen
