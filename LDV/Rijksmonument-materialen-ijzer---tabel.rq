#+ name: Rijksmonument-materialen-ijzer---tabel
#+ endpoint: https://api.linkeddata.cultureelerfgoed.nl/datasets/rce/cho/sparql

prefix ceo: <https://linkeddata.cultureelerfgoed.nl/def/ceo#>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>
prefix graph: <https://linkeddata.cultureelerfgoed.nl/graph/>
prefix skos: <http://www.w3.org/2004/02/skos/core#>

select DISTINCT
  (uri(concat("https://monumentenregister.cultureelerfgoed.nl/monumenten/", ?rijksmonumentnummer)) as ?monumentenregister)
  ?provincie
  ?gevondenMaterialen 
  ?constructieIndicatie
  (group_concat(distinct ?functies; separator=" | ") as ?gecombineerdeFuncties)
  ?omschrijving
where {
  graph graph:instanties-rce {
    ?choi a ceo:Rijksmonument ;
          ceo:rijksmonumentnummer ?rijksmonumentnummer ;
          ceo:heeftOmschrijving ?standpunt_omschrijving .
    
    ?standpunt_omschrijving ceo:omschrijving ?omschrijving_ ;
                            ceo:formeelStandpunt "1"^^<http://www.w3.org/2001/XMLSchema#boolean> .
    
    bind(replace(replace(?omschrijving_, "\r", ""), "\n", "") as ?omschrijving)

    # 1. Materiaal Herkenning
    bind(if(regex(?omschrijving, "gietijzer", "i"), "Gietijzer", "") as ?m1)
    bind(if(regex(?omschrijving, "smeedijzer", "i"), "Smeedijzer", "") as ?m2)
    bind(if(regex(?omschrijving, "welijzer", "i"), "Welijzer", "") as ?m3)
    bind(if(regex(?omschrijving, "\\b(staal|stalen)\\b", "i"), "Staal", "") as ?m4)
    bind(if(regex(?omschrijving, "\\b(ijzer|ijzeren)\\b", "i") && !contains(lcase(?omschrijving), "gietijzer") && !contains(lcase(?omschrijving), "smeedijzer"), "IJzer", "") as ?m5)
    
    bind(replace(concat(?m1, " ", ?m2, " ", ?m3, " ", ?m4, " ", ?m5), " +", " ") as ?rawMaterial)
    bind(replace(replace(?rawMaterial, "^ ", ""), " $", "") as ?gevondenMaterialen)
    
    filter(?gevondenMaterialen != "")

    # 2. Constructie Check
    bind(if(regex(?omschrijving, "\\b(spant|kolom|ligger|trekstang|vakwerk|skelet|profiel|draag|pijler|spil|latei|onderslag)\\b", "i"), "HOOG: Constructieve term", 
         if(regex(?omschrijving, "\\b(hek|balustrade|beslag|kruk|slot|decoratie|ornament|rozet)\\b", "i"), "LAAG: Decoratief", "MEDIUM: Onbekend")) as ?constructieIndicatie)
    
    ?choi ceo:heeftBasisregistratieRelatie/ceo:heeftProvincie ?prov .
  }

  graph graph:owms {
    ?prov skos:prefLabel ?provincie.
  }

  optional {
    ?choi ceo:heeftOorspronkelijkeFunctie ?fRel .
    ?fRel ceo:heeftFunctieNaam/skos:prefLabel ?functie .
    ?fRel ceo:formeelStandpunt "1"^^<http://www.w3.org/2001/XMLSchema#boolean> 
        BIND(REPLACE(?functie, "\\s\\(.*\\)|\\(.*\\)", "") AS ?functies)

  }

  filter(!regex(?omschrijving, "Corten, J.P.|J.P. Corten|Cortenbach", "i"))
}
group by ?rijksmonumentnummer ?provincie ?gevondenMaterialen ?constructieIndicatie ?omschrijving