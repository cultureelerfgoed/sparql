#+ name: Query-4-10-1
#+ endpoint: https://api.linkeddata.cultureelerfgoed.nl/datasets/rce/Rijksmonumenten-sdo/sparql

PREFIX schema:<https://schema.org/>
PREFIX xsd:   <http://www.w3.org/2001/XMLSchema#>

SELECT
  ?primaireCategorie
  ?aantal
  (ROUND(((xsd:decimal(?aantal) * 1000) / xsd:decimal(?totaal)))/10 AS ?percentage)
WHERE {

  ######################################################
  # 1. Totaal aantal rijksmonumenten met â‰¥ 1 categorie
  ######################################################
  {
    SELECT (COUNT(DISTINCT ?choi) AS ?totaal)
    WHERE {
      ?choi schema:description ?omschrijving .
      BIND(LCASE(STR(?omschrijving)) AS ?omslLc)

      VALUES ?zoekterm {
        # Uitsluiting of beperking
        "niet beschermd" "niet-beschermd" "niet van waarde"
        "geen monumentale waarde" "geen onderdeel"
        "uitgesloten" "uitgezonderd"
        "niet opgenomen" "niet onder bescherming"
        "niet meebeschermd" "niet-meebeschermd"
        "niet in aanmerking" "buiten bescherming"
        "niet nader te beschermen"

        # Relatieve waardering
        "ondergeschikt" "van ondergeschikt belang"
        "ondergeschikte waarde" "ondergeschikte betekenis"
        "secundair" "geringe waarde" "weinig waarde" "storend"

        # Verwijzing naar reden van bescherming
        "onderdeel van" "in samenhang met"
        "aanmerking" "aanmerking voor"
      }

      FILTER(CONTAINS(?omslLc, LCASE(?zoekterm)))

      # Uitsluiting of beperking (Project 33)
      BIND(
        "niet-?\\s*beschermd|niet\\s+van\\s+waarde|geen\\s+onderdeel|uitgezonderd|\\buitgesloten\\b|niet\\s+opgenomen|niet\\s+onder\\s+bescherming|niet-?\\s*meebeschermd|niet\\s+in\\s+aanmerking|buiten\\s+bescherming|niet\\s+nader\\s+te\\s+beschermen|geen\\s+monumentale\\s+waarde"
        AS ?patUitsl
      )

      # Relatieve waardering (Project 33; geen constatering, geen "geen monumentale waarde")
      BIND(
        "\\bondergeschikt(e)?\\b|van\\s+ondergeschikt\\s+belang|ondergeschikte\\s+waarde|ondergeschikte\\s+betekenis|\\bsecundair(e)?\\b|weinig\\s+waarde|van\\s+weinig\\s+waarde|\\bgering(e|ere)?\\b|van\\s+geringe\\s+waarde|\\bstorend\\b"
        AS ?patRel
      )

      # Verwijzing naar reden van bescherming (Project 33; compleet)
      BIND(
        "onderdeel\\s+van|in\\s+samenhang\\s+met|aanmerking\\s+voor|\\baanmerking\\b"
        AS ?patReden
      )

      BIND(REGEX(?omslLc, ?patUitsl) AS ?hU)
      BIND(REGEX(?omslLc, ?patRel)   AS ?hR)
      BIND(REGEX(?omslLc, ?patReden) AS ?hV)

      FILTER(?hU || ?hR || ?hV)
      FILTER(!REGEX(?omslLc, "van\\s+belang\\s+als\\s+onderdeel\\s+van"))
    }
  }

  ############################################
  # 2. Aantal per primaire categorie
  ############################################
  {
    SELECT
      ?primaireCategorie
      (COUNT(DISTINCT ?choi) AS ?aantal)
    WHERE {
      ?choi schema:description ?omschrijving .
      BIND(LCASE(STR(?omschrijving)) AS ?omslLc)

      VALUES ?zoekterm {
        # Uitsluiting of beperking
        "niet beschermd" "niet-beschermd" "niet van waarde"
        "geen monumentale waarde" "geen onderdeel"
        "uitgesloten" "uitgezonderd"
        "niet opgenomen" "niet onder bescherming"
        "niet meebeschermd" "niet-meebeschermd"
        "niet in aanmerking" "buiten bescherming"
        "niet nader te beschermen"

        # Relatieve waardering
        "ondergeschikt" "van ondergeschikt belang"
        "ondergeschikte waarde" "ondergeschikte betekenis"
        "secundair" "geringe waarde" "weinig waarde" "storend"

        # Verwijzing naar reden van bescherming
        "onderdeel van" "in samenhang met"
        "aanmerking" "aanmerking voor"
      }

      FILTER(CONTAINS(?omslLc, LCASE(?zoekterm)))

      BIND(
        "niet-?\\s*beschermd|niet\\s+van\\s+waarde|geen\\s+onderdeel|uitgezonderd|\\buitgesloten\\b|niet\\s+opgenomen|niet\\s+onder\\s+bescherming|niet-?\\s*meebeschermd|niet\\s+in\\s+aanmerking|buiten\\s+bescherming|niet\\s+nader\\s+te\\s+beschermen|geen\\s+monumentale\\s+waarde"
        AS ?patUitsl
      )

      BIND(
        "\\bondergeschikt(e)?\\b|van\\s+ondergeschikt\\s+belang|ondergeschikte\\s+waarde|ondergeschikte\\s+betekenis|\\bsecundair(e)?\\b|weinig\\s+waarde|van\\s+weinig\\s+waarde|\\bgering(e|ere)?\\b|van\\s+geringe\\s+waarde|\\bstorend\\b"
        AS ?patRel
      )

      BIND(
        "onderdeel\\s+van|in\\s+samenhang\\s+met|aanmerking\\s+voor|\\baanmerking\\b"
        AS ?patReden
      )

      BIND(REGEX(?omslLc, ?patUitsl) AS ?hU)
      BIND(REGEX(?omslLc, ?patRel)   AS ?hR)
      BIND(REGEX(?omslLc, ?patReden) AS ?hV)

      FILTER(?hU || ?hR || ?hV)
      FILTER(!REGEX(?omslLc, "van\\s+belang\\s+als\\s+onderdeel\\s+van"))

      BIND(
        IF(?hU, "uitsluiting of beperking",
          IF(?hR, "relatieve waardering",
            "verwijzing naar reden van bescherming"
          )
        ) AS ?primaireCategorie
      )
    }
    GROUP BY ?primaireCategorie
  }
}
ORDER BY DESC(?aantal)
