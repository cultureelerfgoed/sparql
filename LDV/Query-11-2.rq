#+ name: Query-11-2
#+ endpoint: https://api.linkeddata.cultureelerfgoed.nl/datasets/joop-van-der-heiden/test-rm-omschrijvingen/services/test-rm-omschrijvingen/sparql

PREFIX text:  <http://jena.apache.org/text#>
PREFIX schema:<https://schema.org/>
PREFIX rdf:   <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX ceo:   <https://linkeddata.cultureelerfgoed.nl/def/ceo#>
PREFIX edm:   <http://www.europeana.eu/schemas/edm/>
PREFIX dc:    <http://purl.org/dc/elements/1.1/>

SELECT DISTINCT
  (URI(CONCAT("https://monumentenregister.cultureelerfgoed.nl/monumenten/", ?rijksmonumentnummer)) AS ?monumentenregister)
  ?provincie
  ?functies
  ?adres
  ?snippet
  ?widget
  ?naam
  ?plaats
  ?monumentaard
WHERE {
  # basisgegevens
  ?choi schema:description      ?omschrijving ;
        schema:identifier       ?rijksmonumentnummer ;
        schema:addressLocality  ?plaats ;
        schema:category         ?monumentaard .

  OPTIONAL {
    ?choi schema:additionalType ?functie .
    BIND(REPLACE(?functie, "\\s\\(.*\\)|\\(.*\\)", "") AS ?functies)
  }
  OPTIONAL { ?choi schema:address       ?adres . }
  OPTIONAL { ?choi schema:name          ?naam  . }
  OPTIONAL { ?choi schema:addressRegion ?provincie . }

  # normaliseer omschrijving voor case-insensitive match
  BIND(LCASE(STR(?omschrijving)) AS ?omslLc)

  # uitsluitingen/beperkingen: patroon
  BIND("niet\\s+beschermd|niet\\s+van\\s+waarde|geen\\s+onderdeel|uitgezonderd|niet\\s+opgenomen|niet\\s+onder\\s+bescherming" AS ?patUitsluiting)

  # filter op omschrijving met uitsluitingen
  FILTER( REGEX(?omslLc, ?patUitsluiting) )

  # eerste gevonden term teruggeven (nu w√©l met correcte grouping)
  BIND(REPLACE(?omslLc, CONCAT(".*?(", ?patUitsluiting, ").*"), "$1") AS ?uitsluitingHit)

  # snippet: toon de volledige omschrijving (zonder highlight, altijd gevuld)
  BIND(STR(?omschrijving) AS ?snippet)

  # widget (eenvoudig HTML-blok, altijd gevuld)
  BIND(STRDT(
    CONCAT(
      '<p><b>Rijksmonument: </b><a href="https://monumentenregister.cultureelerfgoed.nl/monumenten/', STR(?rijksmonumentnummer), '" target="_blank">', STR(?rijksmonumentnummer), '</a></p>',
      '<p>monumentaard: ', COALESCE(STR(?monumentaard), '-'), '</p>',
      '<p>naam: ', COALESCE(STR(?naam), '-'), '</p>',
      '<p>functie: ', COALESCE(STR(?functies), '-'), '</p>',
      '<p>adres: ', COALESCE(STR(?adres), '-'), '</p>',
      '<p>plaats: ', COALESCE(STR(?plaats), '-'), '</p>',
      '<p>provincie: ', COALESCE(STR(?provincie), '-'), '</p>',
      '<p>uitsluiting/beperking gevonden:</br>- ', COALESCE(STR(?uitsluitingHit), '-'), '</p>'
    ),
    rdf:HTML) AS ?widget)
}
LIMIT 100
