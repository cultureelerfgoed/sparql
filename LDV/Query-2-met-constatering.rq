#+ name: Query-2-met-constatering
#+ endpoint: https://api.linkeddata.cultureelerfgoed.nl/datasets/rce/Rijksmonumenten-sdo/sparql

prefix schema:<https://schema.org/>
prefix rdf:   <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
prefix ceo:   <https://linkeddata.cultureelerfgoed.nl/def/ceo#>
prefix edm:   <http://www.europeana.eu/schemas/edm/>
prefix dc:    <http://purl.org/dc/elements/1.1/>

select distinct
  (uri(concat("https://monumentenregister.cultureelerfgoed.nl/monumenten/", ?rijksmonumentnummer)) as ?monumentenregister)
  #?functies
  (group_concat(distinct ?functies; separator=" | ") as ?functies_)
  ?literal
  ?monumentaard
  ?heeftUitsluiting
  ?heeftRelatieveWaardering
  ?heeftReden
  ?heeftConstatering        # NIEUW
  ?primaireCategorie
  ?categorieen

where {

  # Basisgegevens
  ?choi schema:description      ?omschrijving ;
        schema:identifier       ?rijksmonumentnummer ;
        schema:category         ?monumentaard .

  optional {
    ?choi schema:additionalType ?functie .
    bind(replace(?functie, "\\s\\(.*\\)|\\(.*\\)", "") as ?functies)
  }

  # voor compatibiliteit met de oude query: literal = omschrijving
  bind(?omschrijving as ?literal)

  # Omschrijving in lowercase
  bind(lcase(str(?omschrijving)) as ?omslLc)

  ########################################################
  # 1) zoektermen als VALUES, in plaats van text:query
  ########################################################

  values ?zoekterm {
    "niet beschermd" "niet-beschermd" "niet van waarde"
    "geen monumentale waarde" "ondergeschikte waarde"
    "geen onderdeel" "uitgesloten" "uitgezonderd"
    "niet opgenomen" "niet onder bescherming"
    "ondergeschikt" "van ondergeschikt belang" "secundair"
    "onderdeel van" "in samenhang met"
    "niet meebeschermd" "niet-meebeschermd"
    "niet in aanmerking" "buiten bescherming"
    "niet nader te beschermen"
    "niet oorspronkelijk" "niet originele" "niet origineel"
    "in recente tijd" "van latere datum"
    "ondergeschikte betekenis"
    "sterk gewijzigd" "ingrijpend gewijzigd" "aanzienlijk gewijzigd"
  }


  ########################################################
  # 2) classificatie via regex – aangepast
  ########################################################

  # Uitsluiting of beperking
  bind(
    "niet-?\\s*beschermd|niet\\s+van\\s+waarde|geen\\s+onderdeel|uitgezonderd|niet\\s+opgenomen|niet\\s+onder\\s+bescherming|\\buitgesloten\\b|niet-?\\s*meebeschermd|niet\\s+in\\s+aanmerking|\\bafgebroken\\b|buiten\\s+bescherming|niet\\s+nader\\s+te\\s+beschermen"
    as ?patUitsl
  )

  # Relatieve waardering (modern / niet oorspronkelijk / in recente tijd hier UIT)
  bind(
    "\\bondergeschikt(e)?\\b|van\\s+ondergeschikt\\s+belang|ondergeschikte\\s+betekenis|\\bsecundair(e)?\\b|van\\s+weinig\\s+waarde|weinig\\s+waarde|\\bgering(e|ere)?\\b|van\\s+geringe\\s+waarde|\\bstorend\\b|geen\\s+monumentale\\s+waarde|\\b(sterk|ingrijpend|aanzienlijk)\\s+gewijzigd\\b"
    as ?patRel
  )

  # Verwijzing naar reden van bescherming (bewust smal gehouden)
  bind(
    "in\\s+samenhang\\s+met\\s+de\\s+bescherming|aanmerking\\s+voor|\\baanmerking\\b"
    as ?patReden
  )

  # Constatering: feitelijke wijziging of latere toevoeging
  bind(
    "\\bverbouw(d|d[e]?|ing)?\\b|\\bvernieuwd(e)?\\b|\\bvervangen(e)?\\b|\\bgereconstrueerd(e)?\\b|\\bgerestaureerd(e)?\\b|\\bgerenoveerd(e)?\\b|niet\\s+oorspronkelijk(e)?|niet\\s+origineel(e)?|in\\s+recente\\s+tijd|van\\s+latere\\s+datum"
    as ?patConst
  )

  bind( regex(?omslLc, ?patUitsl) as ?heeftUitsluiting )
  bind( regex(?omslLc, ?patRel)   as ?heeftRelatieveWaardering )
  bind( regex(?omslLc, ?patReden) as ?heeftReden )
  bind( regex(?omslLc, ?patConst) as ?heeftConstatering )  # NIEUW

  # minstens één van de vier booleans moet waar zijn
  filter( ?heeftUitsluiting || ?heeftRelatieveWaardering || ?heeftReden || ?heeftConstatering )

  bind(
    if(?heeftUitsluiting, "uitsluiting of beperking",
      if(?heeftRelatieveWaardering, "relatieve waardering",
        if(?heeftReden, "verwijzing naar reden van bescherming", "")
      )
    ) as ?primaireCategorie
  )

  filter( contains(?omslLc, lcase(?zoekterm)) )

  filter( !regex(?omslLc, "van\\s+belang\\s+als\\s+onderdeel\\s+van") )

  bind(concat(
    if(?heeftUitsluiting, "uitsluiting of beperking|", ""),
    if(?heeftRelatieveWaardering, "relatieve waardering|", ""),
    if(?heeftReden, "verwijzing naar reden van bescherming|", ""),
    if(?heeftConstatering, "constatering|", "")          # NIEUW
  ) as ?_cats)

  bind(replace(?_cats, "\\|$", "") as ?categorieen)
}
group by
  ?monumentenregister
  ?rijksmonumentnummer
  ?literal
  ?monumentaard
  ?heeftUitsluiting
  ?heeftRelatieveWaardering
  ?heeftReden
  ?heeftConstatering      
  ?primaireCategorie
  ?categorieen
order by ?heeftConstatering
