#+ name: Query-2-met-constatering
#+ endpoint: https://api.linkeddata.cultureelerfgoed.nl/datasets/rce/Rijksmonumenten-sdo/sparql

PREFIX schema:<https://schema.org/>

SELECT DISTINCT
  (IRI(CONCAT("https://monumentenregister.cultureelerfgoed.nl/monumenten/", ?rijksmonumentnummer)) AS ?monumentenregister)
  (GROUP_CONCAT(DISTINCT ?functies; SEPARATOR=" | ") AS ?functies_)
  ?omschrijving
  ?monumentaard
  ?heeftUitsluiting
  ?heeftRelatieveWaardering
  ?heeftReden
  ?heeftConstatering
  ?primaireCategorie
  ?categorieen
WHERE {
  ?choi schema:description ?omschrijving ;
        schema:identifier  ?rijksmonumentnummer ;
        schema:category    ?monumentaard .

  OPTIONAL {
    ?choi schema:additionalType ?functie .
    BIND(REPLACE(?functie, "\\s\\(.*\\)|\\(.*\\)", "") AS ?functies)
  }

  BIND(LCASE(STR(?omschrijving)) AS ?omslLc)

  ########################################################
  # Prefilter: alleen termen die Project 33 gebruikt
  ########################################################
  VALUES ?zoekterm {
    # 1) Uitsluiting of beperking
    "niet beschermd" "niet-beschermd" "niet van waarde"
    "geen onderdeel" "uitgesloten" "uitgezonderd"
    "niet opgenomen" "niet onder bescherming"
    "niet meebeschermd" "niet-meebeschermd"
    "niet in aanmerking" "buiten bescherming"
    "niet nader te beschermen"
    "geen monumentale waarde"

    # 2) Relatieve waardering
    "ondergeschikt" "van ondergeschikt belang"
    "ondergeschikte waarde" "ondergeschikte betekenis"
    "secundair" "geringe waarde" "weinig waarde" "storend"

    # 3) Reden van bescherming
    "onderdeel van" "in samenhang met"
    "aanmerking" "aanmerking voor"

    # 4) Constatering
    "verbouwd" "vernieuwd" "vervangen"
    "gereconstrueerd" "gerestaureerd" "gerenoveerd"
    "modern" "moderne" "recent" "recente"
    "van latere datum" "van recente datum" "in recente tijd"
    "niet oorspronkelijk" "niet origineel"
    "sterk gewijzigd" "ingrijpend gewijzigd" "aanzienlijk gewijzigd"
  }

  FILTER(CONTAINS(?omslLc, LCASE(?zoekterm)))

  ########################################################
  # Regex-classificatie
  ########################################################

  # 1) Uitsluiting
  BIND(
    "niet-?\\s*beschermd|niet\\s+van\\s+waarde|geen\\s+onderdeel|uitgezonderd|\\buitgesloten\\b|niet\\s+opgenomen|niet\\s+onder\\s+bescherming|niet-?\\s*meebeschermd|niet\\s+in\\s+aanmerking|buiten\\s+bescherming|niet\\s+nader\\s+te\\s+beschermen|geen\\s+monumentale\\s+waarde"
    AS ?patUitsl
  )

  # 2) Relatieve waardering (zonder constateringen)
  BIND(
    "\\bondergeschikt(e)?\\b|van\\s+ondergeschikt\\s+belang|ondergeschikte\\s+waarde|ondergeschikte\\s+betekenis|\\bsecundair(e)?\\b|weinig\\s+waarde|van\\s+weinig\\s+waarde|\\bgering(e|ere)?\\b|van\\s+geringe\\s+waarde|\\bstorend\\b"
    AS ?patRel
  )

  # 3) Reden van bescherming
  BIND(
    "onderdeel\\s+van|in\\s+samenhang\\s+met|aanmerking\\s+voor|\\baanmerking\\b"
    AS ?patReden
  )

  # 4) Constatering
  BIND(
    "\\bverbouw(d|d[e]?|ing)?\\b|\\bvernieuwd(e)?\\b|\\bvervangen(e)?\\b|\\bgereconstrueerd(e)?\\b|\\bgerestaureerd(e)?\\b|\\bgerenoveerd(e)?\\b|\\bmodern(e)?\\b|\\brecent(e|ere)?\\b|niet\\s+oorspronkelijk(e)?|niet\\s+origineel(e)?|in\\s+recente\\s+tijd|van\\s+latere\\s+datum|van\\s+recente\\s+datum|\\b(sterk|ingrijpend|aanzienlijk)\\s+gewijzigd\\b"
    AS ?patConst
  )

  BIND(REGEX(?omslLc, ?patUitsl)  AS ?heeftUitsluiting)
  BIND(REGEX(?omslLc, ?patRel)    AS ?heeftRelatieveWaardering)
  BIND(REGEX(?omslLc, ?patReden)  AS ?heeftReden)
  BIND(REGEX(?omslLc, ?patConst)  AS ?heeftConstatering)

  FILTER(?heeftUitsluiting || ?heeftRelatieveWaardering || ?heeftReden || ?heeftConstatering)

  # Primaire categorie: alleen de 3 hoofdgroepen, in vaste prioriteit
  BIND(
    IF(?heeftUitsluiting, "uitsluiting of beperking",
      IF(?heeftRelatieveWaardering, "relatieve waardering",
        IF(?heeftReden, "verwijzing naar reden van bescherming", "")
      )
    ) AS ?primaireCategorie
  )

  FILTER(!REGEX(?omslLc, "van\\s+belang\\s+als\\s+onderdeel\\s+van"))

  BIND(CONCAT(
    IF(?heeftUitsluiting,         "uitsluiting of beperking|",              ""),
    IF(?heeftRelatieveWaardering, "relatieve waardering|",                  ""),
    IF(?heeftReden,               "verwijzing naar reden van bescherming|", ""),
    IF(?heeftConstatering,        "constatering|",                          "")
  ) AS ?_cats)

  BIND(REPLACE(?_cats, "\\|$", "") AS ?categorieen)
}
GROUP BY
  ?monumentenregister
  ?rijksmonumentnummer
  ?omschrijving
  ?monumentaard
  ?heeftUitsluiting
  ?heeftRelatieveWaardering
  ?heeftReden
  ?heeftConstatering
  ?primaireCategorie
  ?categorieen
ORDER BY ?heeftConstatering
